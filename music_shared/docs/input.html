<!DOCTYPE html><html><head>
      <title>documentation</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/will/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.11/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="technical-documentation">Technical Documentation </h1>
<h2 id="gpu-clicker">GPU Clicker </h2>
<p><a href="https://github.com/willhuff0/GPUClicker">https://github.com/willhuff0/GPUClicker</a></p>
<p>Made in Unity.</p>
<p>Summary of the concept: Clicking the GPU in the middle of the screen generates hashes. Once enough hashes are obtained, a block will be awarded, hashes reset, and the number of hashes required to get the next block increases. To overcome this, the player can prestige to a new cryptocurrency, after which the block difficulty resets and new upgrades are unlocked. Upgrades either generate hashes automatically, or increase the effectiveness of tapping.</p>
<p>The app is available for iOS on TestFlight: <a href="https://testflight.apple.com/join/lw6eOvD1">https://testflight.apple.com/join/lw6eOvD1</a>, and for Android through Google Play internal testing: <a href="https://play.google.com/apps/internaltest/4701185352615742940">https://play.google.com/apps/internaltest/4701185352615742940</a></p>
<p>I use the singleton pattern often so static logic can be connected to the Unity scene.</p>
<pre data-role="codeBlock" data-info="cs" class="language-csharp cs"><code><span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">_load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword keyword-string">string</span></span> json <span class="token operator">=</span> PlayerPrefs<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"save"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">SaveData</span> data<span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-string">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        data <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">SaveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-else">else</span>
    <span class="token punctuation">{</span>
        data <span class="token operator">=</span> JsonConvert<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">DeserializeObject</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SaveData<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    PrestigeController<span class="token punctuation">.</span>Singleton<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword keyword-ref">ref</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    HashController<span class="token punctuation">.</span>Singleton<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword keyword-ref">ref</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    BlockController<span class="token punctuation">.</span>Singleton<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword keyword-ref">ref</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    MiningPoolClaim<span class="token punctuation">.</span>Singleton<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword keyword-ref">ref</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CryptoController<span class="token punctuation">.</span>Singleton<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword keyword-ref">ref</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    UpgradeController<span class="token punctuation">.</span>Singleton<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword keyword-ref">ref</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    RigSpecialMenu<span class="token punctuation">.</span>Singleton<span class="token punctuation">.</span><span class="token function">OnLoad</span><span class="token punctuation">(</span><span class="token keyword keyword-ref">ref</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    UpgradeController<span class="token punctuation">.</span>Singleton<span class="token punctuation">.</span><span class="token function">ApplyBackgroundTicks</span><span class="token punctuation">(</span><span class="token function">_getSecondsSinceLastSave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _firstLoadComplete <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Apply is called on each upgrade type's scriptable object during UpgradeController's load function.</p>
<pre data-role="codeBlock" data-info="cs" class="language-csharp cs"><code><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-override">override</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Apply</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-ulong">ulong</span></span> count<span class="token punctuation">,</span> <span class="token keyword keyword-ref">ref</span> <span class="token class-name">ApplyResult</span> result<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    result<span class="token punctuation">.</span>HashesPerClick <span class="token operator">*=</span> Utils<span class="token punctuation">.</span><span class="token function">IntPow</span><span class="token punctuation">(</span>hashesPerClickMultiplier<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span>HashesPerClick <span class="token operator">+=</span> hashesPerClickAddition <span class="token operator">*</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Utils.IntPow is a very simple optimization for calculating a power</p>
<pre data-role="codeBlock" data-info="cs" class="language-csharp cs"><code><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token return-type class-name"><span class="token keyword keyword-double">double</span></span> <span class="token function">IntPow</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-double">double</span></span> x<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-ulong">ulong</span></span> pow<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>pow <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>pow <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> x<span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword keyword-double">double</span></span> v <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-ulong">ulong</span></span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pow<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> v <span class="token operator">*=</span> x<span class="token punctuation">;</span>

    <span class="token keyword keyword-return">return</span> v<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="windows-automation-and-kiosk-app">Windows Automation and Kiosk App </h2>
<p>For my job at the Goodwill Computer Store.</p>
<h3 id="open-source-projects-used">Open source projects used </h3>
<ul>
<li>Flutter (<a href="https://github.com/flutter/flutter">https://github.com/flutter/flutter</a>): UI toolkit</li>
<li>Chocolatey (<a href="https://github.com/chocolatey/choco">https://github.com/chocolatey/choco</a>): package manager for installing some default programs we include on the computers we sell</li>
</ul>
<p>This datastore class is used to store information such as device specs, benchmark scores, and intermediate information to allow resuming after restarts while installing driver updates.</p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">DataStore</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-static">static</span> <span class="token class-name">String</span> <span class="token function">getStorePath</span><span class="token punctuation">(</span><span class="token class-name">String</span> store<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token class-name">Platform</span><span class="token punctuation">.</span>resolvedExecutable<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'data_store'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">store</span></span><span class="token string">.json'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-final">final</span> <span class="token class-name">String</span> store<span class="token punctuation">;</span>

  <span class="token class-name">DataStore</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword keyword-dynamic">dynamic</span><span class="token punctuation">&gt;</span></span> <span class="token function">toMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">fromMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword keyword-dynamic">dynamic</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">&gt;</span></span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token function">getStorePath</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-await">await</span> file<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>recursive<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> content <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token class-name">JsonEncoder</span><span class="token punctuation">.</span><span class="token function">withIndent</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'    '</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-await">await</span> file<span class="token punctuation">.</span><span class="token function">writeAsString</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-static">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TDataStore</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> read<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TDataStore</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">DataStore</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">TDataStore</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> creator<span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> dataStore <span class="token operator">=</span> <span class="token function">creator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token function">getStorePath</span><span class="token punctuation">(</span>dataStore<span class="token punctuation">.</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword keyword-await">await</span> file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> content <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token keyword keyword-await">await</span> file<span class="token punctuation">.</span><span class="token function">readAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataStore<span class="token punctuation">.</span><span class="token function">fromMap</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-return">return</span> dataStore<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Some of the UI is shown in my video.</p>
<h2 id="nebula">Nebula </h2>
<p>A bare bones game and rendering engine. For rendering, this project uses Google ANGLE to translate OpenGLES to DirectX, Vulkan, or Metal calls. This improves performance compared to native OpenGL drivers. I also wrote a Node tree system with parenting to make nodes move together. Nodes can be extended to do things like render a mesh. The engine manages serialization of assets and has some built in asset types.</p>
<h3 id="open-source-projects-used-1">Open source projects used </h3>
<ul>
<li>ANGLE (<a href="https://github.com/google/angle">https://github.com/google/angle</a>): OpenGLES translation layer</li>
<li>assimp (<a href="https://github.com/assimp/assimp">https://github.com/assimp/assimp</a>): adds support for importing many types of 3D models</li>
<li>ImageSharp (<a href="https://github.com/SixLabors/ImageSharp">https://github.com/SixLabors/ImageSharp</a>): decode and encode textures in compressed formats</li>
</ul>
<h4 id="angle">ANGLE </h4>
<p>Example of a native ANGLE call in Nebula.Graphics, GL.cs</p>
<pre data-role="codeBlock" data-info="cs" class="language-csharp cs"><code><span class="token keyword keyword-using">using</span> <span class="token class-name">GLenum</span> <span class="token operator">=</span> <span class="token class-name">UInt32</span><span class="token punctuation">;</span>
<span class="token keyword keyword-using">using</span> <span class="token class-name">GLsizeiptr</span> <span class="token operator">=</span> <span class="token class-name">Int64</span><span class="token punctuation">;</span>

<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-const">const</span> <span class="token class-name">GLenum</span> ARRAY_BUFFER <span class="token operator">=</span> <span class="token number">0x8892</span><span class="token punctuation">;</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-const">const</span> <span class="token class-name">GLenum</span> STATIC_DRAW <span class="token operator">=</span> <span class="token number">0x88E4</span><span class="token punctuation">;</span>
</code></pre><pre data-role="codeBlock" data-info="cs" class="language-csharp cs"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">LibraryImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span>glesDll<span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">"glBufferData"</span> StringMarshalling <span class="token operator">=</span> StringMarshalling<span class="token punctuation">.</span>Utf8<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-partial">partial</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">BufferData</span><span class="token punctuation">(</span><span class="token class-name">GLenum</span> target<span class="token punctuation">,</span> <span class="token class-name">GLsizeiptr</span> size<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-byte">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> data<span class="token punctuation">,</span> <span class="token class-name">GLenum</span> usage<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><pre data-role="codeBlock" data-info="cs" class="language-csharp cs"><code>GL<span class="token punctuation">.</span><span class="token function">BufferData</span><span class="token punctuation">(</span>GL<span class="token punctuation">.</span>ARRAY_BUFFER<span class="token punctuation">,</span> vertexData<span class="token punctuation">.</span>LongLength<span class="token punctuation">,</span> vertexData<span class="token punctuation">,</span> GL<span class="token punctuation">.</span>STATIC_DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>bufferData in OpenGLES / ANGLE uploads data to the GPU, which contains a list of packed vertex data. Usually, position, texture coordinate, and normal direction information is placed side by side in the array. A call to vertexAttribPointer specifies the exact layout of this information so it can be used correctly in shaders.</p>
<h4 id="rendershader">RenderShader </h4>
<p>This asset loads a vertex and fragment shader for use in material assets, which usually hold a reference to a common shader paired with different textures or parameters.</p>
<pre data-role="codeBlock" data-info="cs" class="language-csharp cs"><code><span class="token keyword keyword-using">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Numerics</span><span class="token punctuation">;</span>
<span class="token keyword keyword-using">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>Nodes</span><span class="token punctuation">;</span>
<span class="token keyword keyword-using">using</span> <span class="token namespace">Nebula<span class="token punctuation">.</span>Graphics</span><span class="token punctuation">;</span>

<span class="token keyword keyword-namespace">namespace</span> <span class="token namespace">Nebula<span class="token punctuation">.</span>Engine<span class="token punctuation">.</span>Assets</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AssetDefinition</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"renderShaders"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">RenderShader</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">FileAsset</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token class-name"><span class="token keyword keyword-string">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> _imports<span class="token punctuation">;</span>

    <span class="token keyword keyword-public">public</span> <span class="token function">RenderShader</span><span class="token punctuation">(</span><span class="token class-name">Project</span> project<span class="token punctuation">,</span> <span class="token class-name">JsonNode</span> json<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword keyword-base">base</span><span class="token punctuation">(</span>project<span class="token punctuation">,</span> json<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _imports <span class="token operator">=</span> json<span class="token punctuation">[</span><span class="token string">"imports"</span><span class="token punctuation">]</span><span class="token punctuation">?.</span><span class="token generic-method"><span class="token function">GetValue</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword keyword-string">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">??</span> Array<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Empty</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword keyword-string">string</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-override">override</span> <span class="token return-type class-name">JsonObject</span> <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword keyword-var">var</span></span> json <span class="token operator">=</span> <span class="token keyword keyword-base">base</span><span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        json<span class="token punctuation">[</span><span class="token string">"imports"</span><span class="token punctuation">]</span> <span class="token operator">=</span> JsonValue<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>_imports<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> json<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-override">override</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>RuntimeAsset<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword keyword-var">var</span></span> content <span class="token operator">=</span> <span class="token function">FileAssetGetText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword keyword-var">var</span></span> lines <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword keyword-string">string</span></span> preamble <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> vertexSource <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> fragmentSource <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword keyword-int">int</span></span> stage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-foreach">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-var">var</span></span> line <span class="token keyword keyword-in">in</span> lines<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span><span class="token string">"#VERTEX"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                stage <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span><span class="token string">"#FRAGMENT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                stage <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>stage<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword keyword-case">case</span> <span class="token number">0</span><span class="token punctuation">:</span> 
                    preamble <span class="token operator">+=</span> line <span class="token operator">+</span> <span class="token char">'\n'</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-case">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    vertexSource <span class="token operator">+=</span> line <span class="token operator">+</span> <span class="token char">'\n'</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-case">case</span> <span class="token number">2</span><span class="token punctuation">:</span>
                    fragmentSource <span class="token operator">+=</span> line <span class="token operator">+</span> <span class="token char">'\n'</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-int">int</span></span> i <span class="token operator">=</span> _imports<span class="token punctuation">.</span>Length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword keyword-var">var</span></span> library <span class="token operator">=</span> LibraryShader<span class="token punctuation">.</span><span class="token function">FindById</span><span class="token punctuation">(</span>_imports<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>library <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                vertexSource <span class="token operator">=</span> vertexSource<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> library<span class="token punctuation">.</span>Content <span class="token operator">+</span> <span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                fragmentSource <span class="token operator">=</span> fragmentSource<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> library<span class="token punctuation">.</span>Content <span class="token operator">+</span> <span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        vertexSource <span class="token operator">=</span> vertexSource<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> preamble <span class="token operator">+</span> <span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fragmentSource <span class="token operator">=</span> fragmentSource<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> preamble <span class="token operator">+</span> <span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name"><span class="token keyword keyword-var">var</span></span> vertexShader <span class="token operator">=</span> GL<span class="token punctuation">.</span><span class="token function">CreateShader</span><span class="token punctuation">(</span>GL<span class="token punctuation">.</span>VERTEX_SHADER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        GL<span class="token punctuation">.</span><span class="token function">ShaderSource</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name"><span class="token keyword keyword-string">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span> vertexSource <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GL<span class="token punctuation">.</span><span class="token function">CompileShader</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        GL<span class="token punctuation">.</span><span class="token function">GetShader</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">,</span> GL<span class="token punctuation">.</span>COMPILE_STATUS<span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> GL<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            GL<span class="token punctuation">.</span><span class="token function">GetShaderInfoLog</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> length<span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> <span class="token class-name"><span class="token keyword keyword-string">string</span></span> infoLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            GL<span class="token punctuation">.</span><span class="token function">DeleteShader</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Error compiling vertex shader (</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Name</span><span class="token punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">infoLog</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> Task<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromResult</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RuntimeAsset<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword keyword-null">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token class-name"><span class="token keyword keyword-var">var</span></span> fragmentShader <span class="token operator">=</span> GL<span class="token punctuation">.</span><span class="token function">CreateShader</span><span class="token punctuation">(</span>GL<span class="token punctuation">.</span>FRAGMENT_SHADER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        GL<span class="token punctuation">.</span><span class="token function">ShaderSource</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name"><span class="token keyword keyword-string">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span> fragmentSource <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GL<span class="token punctuation">.</span><span class="token function">CompileShader</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        GL<span class="token punctuation">.</span><span class="token function">GetShader</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">,</span> GL<span class="token punctuation">.</span>COMPILE_STATUS<span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> GL<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            GL<span class="token punctuation">.</span><span class="token function">GetShaderInfoLog</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> length<span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> <span class="token class-name"><span class="token keyword keyword-string">string</span></span> infoLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            GL<span class="token punctuation">.</span><span class="token function">DeleteShader</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Error compiling fragment shader (</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Name</span><span class="token punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">infoLog</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> Task<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromResult</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RuntimeAsset<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword keyword-null">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name"><span class="token keyword keyword-var">var</span></span> program <span class="token operator">=</span> GL<span class="token punctuation">.</span><span class="token function">CreateProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GL<span class="token punctuation">.</span><span class="token function">AttachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        GL<span class="token punctuation">.</span><span class="token function">AttachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        GL<span class="token punctuation">.</span><span class="token function">LinkProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
        GL<span class="token punctuation">.</span><span class="token function">DetachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        GL<span class="token punctuation">.</span><span class="token function">DetachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        GL<span class="token punctuation">.</span><span class="token function">DeleteShader</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        GL<span class="token punctuation">.</span><span class="token function">DeleteShader</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        GL<span class="token punctuation">.</span><span class="token function">GetProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> GL<span class="token punctuation">.</span>LINK_STATUS<span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> GL<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            GL<span class="token punctuation">.</span><span class="token function">GetProgramInfoLog</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> length<span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> <span class="token class-name"><span class="token keyword keyword-string">string</span></span> infoLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            GL<span class="token punctuation">.</span><span class="token function">DeleteProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Error linking program (</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Name</span><span class="token punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">infoLog</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-return">return</span> Task<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromResult</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RuntimeAsset<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword keyword-null">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        GL<span class="token punctuation">.</span><span class="token function">GetProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> GL<span class="token punctuation">.</span>ACTIVE_UNIFORMS<span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> uniformCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword keyword-string">string</span><span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span><span class="token punctuation">&gt;</span></span> uniformLocations <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword keyword-string">string</span><span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>uniformCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-uint">uint</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> uniformCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            GL<span class="token punctuation">.</span><span class="token function">GetActiveUniform</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> length<span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> size<span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> <span class="token class-name"><span class="token keyword keyword-uint">uint</span></span> type<span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> <span class="token class-name"><span class="token keyword keyword-string">string</span></span> uniformName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            uniformLocations<span class="token punctuation">[</span>uniformName<span class="token punctuation">]</span> <span class="token operator">=</span> GL<span class="token punctuation">.</span><span class="token function">GetUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> uniformName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-return">return</span> Task<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromResult</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RuntimeAsset<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">RuntimeRenderShader</span><span class="token punctuation">(</span>Project<span class="token punctuation">,</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span> program<span class="token punctuation">,</span> uniformLocations<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">RuntimeRenderShader</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">RuntimeAsset</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-readonly">readonly</span> <span class="token class-name"><span class="token keyword keyword-uint">uint</span></span> _program<span class="token punctuation">;</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-readonly">readonly</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword keyword-string">string</span><span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span><span class="token punctuation">&gt;</span></span> _uniformLocations<span class="token punctuation">;</span>

    <span class="token keyword keyword-public">public</span> <span class="token function">RuntimeRenderShader</span><span class="token punctuation">(</span><span class="token class-name">Project</span> project<span class="token punctuation">,</span> <span class="token class-name">Asset</span> from<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-uint">uint</span></span> program<span class="token punctuation">,</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword keyword-string">string</span><span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span><span class="token punctuation">&gt;</span></span> uniformLocations<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword keyword-base">base</span><span class="token punctuation">(</span>project<span class="token punctuation">,</span> from<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _program <span class="token operator">=</span> program<span class="token punctuation">;</span>
        _uniformLocations <span class="token operator">=</span> uniformLocations<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-override">override</span> <span class="token return-type class-name">Task</span> <span class="token function">Unload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        GL<span class="token punctuation">.</span><span class="token function">DeleteProgram</span><span class="token punctuation">(</span>_program<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword keyword-return">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> GL<span class="token punctuation">.</span><span class="token function">UseProgram</span><span class="token punctuation">(</span>_program<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">SetUniform</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-float">float</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> GL<span class="token punctuation">.</span><span class="token function">ProgramUniform</span><span class="token punctuation">(</span>_program<span class="token punctuation">,</span> _uniformLocations<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">SetUniform</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name">Vector2</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> GL<span class="token punctuation">.</span><span class="token function">ProgramUniform</span><span class="token punctuation">(</span>_program<span class="token punctuation">,</span> _uniformLocations<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>X<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">SetUniform</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name">Vector3</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> GL<span class="token punctuation">.</span><span class="token function">ProgramUniform</span><span class="token punctuation">(</span>_program<span class="token punctuation">,</span> _uniformLocations<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>X<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>Y<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>Z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">SetUniform</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name">Vector4</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> GL<span class="token punctuation">.</span><span class="token function">ProgramUniform</span><span class="token punctuation">(</span>_program<span class="token punctuation">,</span> _uniformLocations<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>X<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>Y<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>Z<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>W<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">SetUniform</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> GL<span class="token punctuation">.</span><span class="token function">ProgramUniform</span><span class="token punctuation">(</span>_program<span class="token punctuation">,</span> _uniformLocations<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">SetUniform</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> v0<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> v1<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> GL<span class="token punctuation">.</span><span class="token function">ProgramUniform</span><span class="token punctuation">(</span>_program<span class="token punctuation">,</span> _uniformLocations<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">SetUniform</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> v0<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> v1<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> v2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> GL<span class="token punctuation">.</span><span class="token function">ProgramUniform</span><span class="token punctuation">(</span>_program<span class="token punctuation">,</span> _uniformLocations<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">SetUniform</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> v0<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> v1<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> v2<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> v3<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> GL<span class="token punctuation">.</span><span class="token function">ProgramUniform</span><span class="token punctuation">(</span>_program<span class="token punctuation">,</span> _uniformLocations<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">SetUniform</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-bool">bool</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> GL<span class="token punctuation">.</span><span class="token function">ProgramUniform</span><span class="token punctuation">(</span>_program<span class="token punctuation">,</span> _uniformLocations<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span> <span class="token punctuation">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">SetUniform</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name">Matrix4x4</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> GL<span class="token punctuation">.</span><span class="token function">ProgramUniformMatrix4</span><span class="token punctuation">(</span>_program<span class="token punctuation">,</span> _uniformLocations<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword keyword-new">new</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M11<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M21<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M31<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M41<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M12<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M22<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M32<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M42<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M13<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M23<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M33<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M43<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M14<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M24<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M34<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">.</span>M44 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">SetUniform</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-object">object</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span><span class="token keyword keyword-value">value</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-case">case</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> val<span class="token punctuation">:</span> 
                <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-case">case</span> <span class="token class-name"><span class="token keyword keyword-bool">bool</span></span> val<span class="token punctuation">:</span>
                <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-case">case</span> <span class="token class-name"><span class="token keyword keyword-float">float</span></span> val<span class="token punctuation">:</span>
                <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-case">case</span> <span class="token class-name">Vector2</span> val<span class="token punctuation">:</span>
                <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-case">case</span> <span class="token class-name">Vector3</span> val<span class="token punctuation">:</span>
                <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-case">case</span> <span class="token class-name">Vector4</span> val<span class="token punctuation">:</span>
                <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-case">case</span> <span class="token class-name"><span class="token keyword keyword-int">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> val<span class="token punctuation">:</span>
                <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>val<span class="token punctuation">.</span>Length<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword keyword-case">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
                        <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-case">case</span> <span class="token number">2</span><span class="token punctuation">:</span>
                        <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-case">case</span> <span class="token number">3</span><span class="token punctuation">:</span>
                        <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-case">case</span> <span class="token number">4</span><span class="token punctuation">:</span>
                        <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-case">case</span> <span class="token class-name"><span class="token keyword keyword-float">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> val<span class="token punctuation">:</span>
                <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>val<span class="token punctuation">.</span>Length<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword keyword-case">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
                        <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-case">case</span> <span class="token number">2</span><span class="token punctuation">:</span>
                        <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Vector2</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-case">case</span> <span class="token number">3</span><span class="token punctuation">:</span>
                        <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Vector3</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-case">case</span> <span class="token number">4</span><span class="token punctuation">:</span>
                        <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Vector4</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-case">case</span> <span class="token number">16</span><span class="token punctuation">:</span>
                        <span class="token function">SetUniform</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Matrix4x4</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="physically-based-rendering">Physically Based Rendering </h4>
<p>A fragment shader which uses PBR BRDF, with the rather common Smith GGX model for specular, Cook-Torrance for fresnel, and Lambert for diffuse.</p>
<pre data-role="codeBlock" data-info="glsl" class="language-glsl glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">310</span> es</span></span>
<span class="token keyword keyword-precision">precision</span> <span class="token keyword keyword-highp">highp</span> <span class="token keyword keyword-float">float</span><span class="token punctuation">;</span>

<span class="token keyword keyword-out">out</span> <span class="token keyword keyword-vec4">vec4</span> FragColor<span class="token punctuation">;</span>

<span class="token keyword keyword-layout">layout</span><span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-in">in</span> <span class="token keyword keyword-vec2">vec2</span> v_texCoord<span class="token punctuation">;</span>
<span class="token keyword keyword-layout">layout</span><span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword keyword-in">in</span> <span class="token keyword keyword-vec3">vec3</span> v_worldPos<span class="token punctuation">;</span>
<span class="token keyword keyword-layout">layout</span><span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword keyword-in">in</span> <span class="token keyword keyword-vec3">vec3</span> v_normal<span class="token punctuation">;</span>

<span class="token keyword keyword-layout">layout</span><span class="token punctuation">(</span>binding <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-uniform">uniform</span> <span class="token keyword keyword-sampler2D">sampler2D</span> nebula_texture_albedo<span class="token punctuation">;</span>
<span class="token keyword keyword-layout">layout</span><span class="token punctuation">(</span>binding <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword keyword-uniform">uniform</span> <span class="token keyword keyword-sampler2D">sampler2D</span> nebula_texture_metallicRoughnessOcclusion<span class="token punctuation">;</span>
<span class="token keyword keyword-layout">layout</span><span class="token punctuation">(</span>binding <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword keyword-uniform">uniform</span> <span class="token keyword keyword-sampler2D">sampler2D</span> nebula_texture_normal<span class="token punctuation">;</span>

<span class="token keyword keyword-layout">layout</span><span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword keyword-uniform">uniform</span> <span class="token keyword keyword-vec3">vec3</span> nebula_worldViewPos<span class="token punctuation">;</span>

<span class="token keyword keyword-layout">layout</span><span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword keyword-uniform">uniform</span> <span class="token keyword keyword-vec3">vec3</span> nebula_directionalLight_direction<span class="token punctuation">;</span>
<span class="token keyword keyword-layout">layout</span><span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword keyword-uniform">uniform</span> <span class="token keyword keyword-vec3">vec3</span> nebula_directionalLight_color<span class="token punctuation">;</span>
<span class="token keyword keyword-layout">layout</span><span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword keyword-uniform">uniform</span> <span class="token keyword keyword-float">float</span> nebula_directionalLight_illuminance<span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> <span class="token keyword keyword-float">float</span> PI <span class="token operator">=</span> <span class="token number">3.14159265359</span><span class="token punctuation">;</span>

<span class="token comment">//------------------</span>
<span class="token comment">//  Specular</span>

<span class="token comment">// GGX NDF</span>
<span class="token keyword keyword-float">float</span> <span class="token function">specular_distribution</span><span class="token punctuation">(</span><span class="token keyword keyword-float">float</span> NoH<span class="token punctuation">,</span> <span class="token keyword keyword-float">float</span> roughness<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-float">float</span> a <span class="token operator">=</span> NoH <span class="token operator">*</span> roughness<span class="token punctuation">;</span>
    <span class="token keyword keyword-float">float</span> k <span class="token operator">=</span> roughness <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> NoH <span class="token operator">*</span> NoH <span class="token operator">+</span> a <span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> k <span class="token operator">*</span> k <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> PI<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Smith GGX geometric shadowing</span>
<span class="token keyword keyword-float">float</span> <span class="token function">specular_visibility</span><span class="token punctuation">(</span><span class="token keyword keyword-float">float</span> NoV<span class="token punctuation">,</span> <span class="token keyword keyword-float">float</span> NoL<span class="token punctuation">,</span> <span class="token keyword keyword-float">float</span> roughness<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-float">float</span> a2 <span class="token operator">=</span> roughness <span class="token operator">*</span> roughness<span class="token punctuation">;</span>
    <span class="token keyword keyword-float">float</span> GGXV <span class="token operator">=</span> NoL <span class="token operator">*</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>NoV <span class="token operator">*</span> NoV <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> a2<span class="token punctuation">)</span> <span class="token operator">+</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-float">float</span> GGXL <span class="token operator">=</span> NoV <span class="token operator">*</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>NoL <span class="token operator">*</span> NoL <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> a2<span class="token punctuation">)</span> <span class="token operator">+</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">0.5</span> <span class="token operator">/</span> <span class="token punctuation">(</span>GGXV <span class="token operator">+</span> GGXL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Schlick Cook-Torrance approximation fresnel</span>
<span class="token keyword keyword-vec3">vec3</span> <span class="token function">specular_fresnel</span><span class="token punctuation">(</span><span class="token keyword keyword-float">float</span> u<span class="token punctuation">,</span> <span class="token keyword keyword-vec3">vec3</span> f0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-float">float</span> f <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> u<span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> f <span class="token operator">+</span> f0 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//------------------</span>


<span class="token comment">//------------------</span>
<span class="token comment">//  Diffuse</span>

<span class="token comment">// Lambert diffuse</span>
<span class="token keyword keyword-float">float</span> <span class="token function">diffuse_lambert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">1.0</span> <span class="token operator">/</span> PI<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//------------------</span>

<span class="token keyword keyword-void">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-vec3">vec3</span> baseColor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>nebula_texture_albedo<span class="token punctuation">,</span> v_texCoord<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>

    <span class="token keyword keyword-vec3">vec3</span> inMetallicRoughnessOcclusion <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>nebula_texture_metallicRoughnessOcclusion<span class="token punctuation">,</span> v_texCoord<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
    <span class="token keyword keyword-float">float</span> metallic <span class="token operator">=</span> inMetallicRoughnessOcclusion<span class="token punctuation">.</span>r<span class="token punctuation">;</span>
    <span class="token keyword keyword-float">float</span> roughness <span class="token operator">=</span> inMetallicRoughnessOcclusion<span class="token punctuation">.</span>g <span class="token operator">*</span> inMetallicRoughnessOcclusion<span class="token punctuation">.</span>g<span class="token punctuation">;</span>
    <span class="token keyword keyword-float">float</span> occlusion <span class="token operator">=</span> inMetallicRoughnessOcclusion<span class="token punctuation">.</span>b<span class="token punctuation">;</span>

    <span class="token keyword keyword-vec3">vec3</span> diffuseColor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> metallic<span class="token punctuation">)</span> <span class="token operator">*</span> baseColor<span class="token punctuation">;</span>
    <span class="token keyword keyword-vec3">vec3</span> f0 <span class="token operator">=</span> <span class="token number">0.16</span> <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> metallic<span class="token punctuation">)</span> <span class="token operator">+</span> baseColor <span class="token operator">*</span> metallic<span class="token punctuation">;</span>

    <span class="token keyword keyword-vec3">vec3</span> n <span class="token operator">=</span> v_normal<span class="token punctuation">;</span>
    <span class="token keyword keyword-vec3">vec3</span> v <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_worldPos <span class="token operator">-</span> nebula_worldViewPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-vec3">vec3</span> l <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token operator">-</span>nebula_directionalLight_direction<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-vec3">vec3</span> h <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v <span class="token operator">+</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-float">float</span> NoV <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1e-5</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-float">float</span> NoL <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-float">float</span> NoH <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-float">float</span> LoH <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-float">float</span> D <span class="token operator">=</span> <span class="token function">specular_distribution</span><span class="token punctuation">(</span>NoH<span class="token punctuation">,</span> roughness<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-vec3">vec3</span> F <span class="token operator">=</span> <span class="token function">specular_fresnel</span><span class="token punctuation">(</span>LoH<span class="token punctuation">,</span> f0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-float">float</span> V <span class="token operator">=</span> <span class="token function">specular_visibility</span><span class="token punctuation">(</span>NoV<span class="token punctuation">,</span> NoL<span class="token punctuation">,</span> roughness<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-vec3">vec3</span> specular <span class="token operator">=</span> <span class="token punctuation">(</span>D <span class="token operator">*</span> V<span class="token punctuation">)</span> <span class="token operator">*</span> F<span class="token punctuation">;</span>
    <span class="token keyword keyword-vec3">vec3</span> diffuse <span class="token operator">=</span> diffuseColor <span class="token operator">*</span> <span class="token function">diffuse_lambert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-vec3">vec3</span> brdf <span class="token operator">=</span> diffuse <span class="token operator">+</span> specular<span class="token punctuation">;</span>

    <span class="token keyword keyword-float">float</span> illuminance <span class="token operator">=</span> nebula_directionalLight_illuminance <span class="token operator">*</span> NoL<span class="token punctuation">;</span>
    <span class="token keyword keyword-vec3">vec3</span> luminance <span class="token operator">=</span> brdf <span class="token operator">*</span> illuminance<span class="token punctuation">;</span>

    FragColor <span class="token operator">=</span> <span class="token keyword keyword-vec4">vec4</span><span class="token punctuation">(</span>luminance<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="music-service">Music Service </h2>
<p><a href="https://github.com/willhuff0/music_fullstack">https://github.com/willhuff0/music_fullstack</a></p>
<p>A full stack music streaming service built from scratch.</p>
<p>I created this project mostly for fun. Later, I adapted it to solve a specific problem I was having. I wanted a way to synchronize speakers in my home.</p>
<h3 id="open-source-projects-used-2">Open source projects used </h3>
<h4 id="server">Server </h4>
<ul>
<li>Dart (<a href="https://github.com/dart-lang">https://github.com/dart-lang</a>)</li>
<li>Isar (<a href="https://github.com/isar/isar">https://github.com/isar/isar</a>): Document database</li>
<li>dart_phonetics (<a href="https://github.com/raycardillo/dart_phonetics">https://github.com/raycardillo/dart_phonetics</a>): Provides the double metaphone algorithm</li>
<li>Shelf (<a href="https://github.com/dart-lang/shelf">https://github.com/dart-lang/shelf</a>): Web Server Middleware for Dart</li>
<li>Cryptography (<a href="https://github.com/dint-dev/cryptography">https://github.com/dint-dev/cryptography</a>): Provides argon2id, Hmac and sha256 implementations</li>
<li>dart-uuid (<a href="https://github.com/Daegalus/dart-uuid">https://github.com/Daegalus/dart-uuid</a>): Uuid generation</li>
</ul>
<h4 id="client">Client </h4>
<ul>
<li>Flutter (<a href="https://github.com/flutter/flutter">https://github.com/flutter/flutter</a>): UI toolkit</li>
<li>just_audio (<a href="https://github.com/ryanheise/just_audio">https://github.com/ryanheise/just_audio</a>): Audio player for Flutter</li>
<li>flutter_secure_storage (<a href="https://github.com/mogol/flutter_secure_storage">https://github.com/mogol/flutter_secure_storage</a>): Access to iOS keychain etc</li>
<li>dyn_mouse_scroll (<a href="https://github.com/alesimula/dyn_mouse_scroll">https://github.com/alesimula/dyn_mouse_scroll</a>): Fixes an issue with scrolling in Flutter</li>
<li>infinite_scroll_pagination (<a href="https://github.com/EdsonBueno/infinite_scroll_pagination">https://github.com/EdsonBueno/infinite_scroll_pagination</a>): Drop in pagination for scrolling views</li>
<li>desktop_drop (<a href="https://github.com/MixinNetwork/flutter-plugins/tree/main/packages/desktop_drop">https://github.com/MixinNetwork/flutter-plugins/tree/main/packages/desktop_drop</a>): Drag and drop files into Flutter app</li>
<li>synchronized (<a href="https://github.com/tekartik/synchronized.dart">https://github.com/tekartik/synchronized.dart</a>): Provides locking for async dart code</li>
<li>flutter_file_picker (<a href="https://github.com/miguelpruivo/flutter_file_picker">https://github.com/miguelpruivo/flutter_file_picker</a>): File picker on desktop</li>
</ul>
<h3 id="stateless-server">Stateless Server </h3>
<h4 id="worker">Worker </h4>
<p>The class mainly deals with Dart's threading system. To avoid common multithreading related bugs, Dart doesn't allow shared memory between threads (yet). Which is why, I assume, they call threads Isolates. To exchange information messages have to be sent over ports, which can be a pain, and is why I keep all of that logic out of mind in these classes.</p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">WorkerManager</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">Isolate</span> _isolate<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword keyword-dynamic">dynamic</span><span class="token punctuation">&gt;</span></span> fromIsolateStream<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">SendPort</span> toIsolatePort<span class="token punctuation">;</span>

  late <span class="token keyword keyword-final">final</span> <span class="token class-name">StreamSubscription</span> _fromIsolateSubscription<span class="token punctuation">;</span>

  <span class="token class-name">WorkerManager</span><span class="token punctuation">.</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>_isolate<span class="token punctuation">,</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>fromIsolateStream<span class="token punctuation">,</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>toIsolatePort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _fromIsolateSubscription <span class="token operator">=</span> fromIsolateStream<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-static">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WorkerManager</span><span class="token punctuation">&gt;</span></span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">WorkerLaunchArgs</span> args<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> fromIsolatePort <span class="token operator">=</span> <span class="token class-name">ReceivePort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> fromIsolatePortBroadcast <span class="token operator">=</span> fromIsolatePort<span class="token punctuation">.</span><span class="token function">asBroadcastStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> isolate <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token class-name">Isolate</span><span class="token punctuation">.</span>spawn<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">SendPort</span><span class="token punctuation">,</span> <span class="token class-name">WorkerLaunchArgs</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">WorkerIsolate</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>$<span class="token number">2</span><span class="token punctuation">,</span> debugName<span class="token punctuation">:</span> message<span class="token punctuation">.</span>$<span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span>fromIsolatePort<span class="token punctuation">.</span>sendPort<span class="token punctuation">,</span> args<span class="token punctuation">,</span> debugName<span class="token punctuation">)</span><span class="token punctuation">,</span>
      debugName<span class="token punctuation">:</span> debugName<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> toIsolatePort <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> fromIsolatePortBroadcast<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token class-name">WorkerManager</span><span class="token punctuation">.</span><span class="token function">_</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> fromIsolatePortBroadcast<span class="token punctuation">,</span> toIsolatePort<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">&gt;</span></span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
    toIsolatePort<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'shutdown'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">WorkerIsolate</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">Worker</span> _worker<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword keyword-dynamic">dynamic</span><span class="token punctuation">&gt;</span></span> _fromManagerStream<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">SendPort</span> _toManagerPort<span class="token punctuation">;</span>

  late <span class="token keyword keyword-final">final</span> <span class="token class-name">StreamSubscription</span> _fromManagerSubscription<span class="token punctuation">;</span>

  <span class="token class-name">WorkerIsolate</span><span class="token punctuation">.</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>_worker<span class="token punctuation">,</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>_fromManagerStream<span class="token punctuation">,</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>_toManagerPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _fromManagerSubscription <span class="token operator">=</span> _fromManagerStream<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-case">case</span> <span class="token string-literal"><span class="token string">'shutdown'</span></span><span class="token punctuation">:</span>
          <span class="token function">_shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-static">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WorkerIsolate</span><span class="token punctuation">&gt;</span></span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token class-name">SendPort</span> toManagerPort<span class="token punctuation">,</span> <span class="token class-name">WorkerLaunchArgs</span> args<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> fromManagerPort <span class="token operator">=</span> <span class="token class-name">ReceivePort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    toManagerPort<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>fromManagerPort<span class="token punctuation">.</span>sendPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> fromManagerStream <span class="token operator">=</span> fromManagerPort<span class="token punctuation">.</span><span class="token function">asBroadcastStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> worker <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> args<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> fromManagerStream<span class="token punctuation">,</span> toManagerPort<span class="token punctuation">,</span> debugName<span class="token punctuation">:</span> debugName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-return">return</span> <span class="token class-name">WorkerIsolate</span><span class="token punctuation">.</span><span class="token function">_</span><span class="token punctuation">(</span>worker<span class="token punctuation">,</span> fromManagerStream<span class="token punctuation">,</span> toManagerPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">&gt;</span></span> <span class="token function">_shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
    _worker<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _fromManagerSubscription<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-interface">interface</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">&gt;</span></span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">WorkerLaunchArgs</span> <span class="token punctuation">{</span>
  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Worker</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">WorkerLaunchArgs</span> args<span class="token punctuation">,</span> <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword keyword-dynamic">dynamic</span><span class="token punctuation">&gt;</span></span> fromManagerStream<span class="token punctuation">,</span> <span class="token class-name">SendPort</span> toManagerPort<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">}</span><span class="token punctuation">)</span> start<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">ServerConfig</span> config<span class="token punctuation">;</span>

  <span class="token class-name">WorkerLaunchArgs</span><span class="token punctuation">(</span><span class="token punctuation">{</span>required <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>start<span class="token punctuation">,</span> required <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>config<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">WorkerLaunchArgsWithAuthentication</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">WorkerLaunchArgs</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">Uint8List</span> privateKey<span class="token punctuation">;</span>

  <span class="token class-name">WorkerLaunchArgsWithAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">{</span>required <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span>start<span class="token punctuation">,</span> required <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span>config<span class="token punctuation">,</span> required <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>privateKey<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><h5 id="apiworker">APIWorker </h5>
<p>This class implements the Worker interface and allows me to provide list of CustomHandler objects, which take a route and a closure to be executed when an http request is received. I extend CustomHandlerBase to CustomHandlerAuthRequired which inserts some extra code before calling the provided closure to automatically handle authentication tokens. Since the closure may be executed on some arbitrary thread, CustomThreadData is passed to allow access to some thread bound state, such as the Isar database reference.</p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">APIWorker</span> <span class="token keyword keyword-implements">implements</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">APIWorkerLaunchArgs</span> _args<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">HttpServer</span> _server<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">Router</span> _router<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">CustomThreadData</span> _threadData<span class="token punctuation">;</span>

  <span class="token class-name">APIWorker</span><span class="token punctuation">.</span><span class="token function">_</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>_server<span class="token punctuation">,</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">,</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>_threadData<span class="token punctuation">,</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>_args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-final">final</span> customHandler <span class="token keyword keyword-in">in</span> _args<span class="token punctuation">.</span>customHandlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">addCustomHandler</span><span class="token punctuation">(</span>customHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-static">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Worker</span><span class="token punctuation">&gt;</span></span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">WorkerLaunchArgs</span> args<span class="token punctuation">,</span> <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword keyword-dynamic">dynamic</span><span class="token punctuation">&gt;</span></span> fromManagerStream<span class="token punctuation">,</span> <span class="token class-name">SendPort</span> toManagerPort<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token class-name">String</span><span class="token operator">?</span> debugName<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>args <span class="token operator">is!</span> <span class="token class-name">APIWorkerLaunchArgs</span><span class="token punctuation">)</span> <span class="token keyword keyword-throw">throw</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'APIWorker must be started with APIWorkerLaunchArgs'</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> threadData <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> args<span class="token punctuation">.</span><span class="token function">createThreadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> router <span class="token operator">=</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> handler <span class="token operator">=</span> <span class="token class-name">Pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addMiddleware</span><span class="token punctuation">(</span><span class="token function">logRequests</span><span class="token punctuation">(</span>logger<span class="token punctuation">:</span> debugName <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span> <span class="token operator">?</span> <span class="token punctuation">(</span>message<span class="token punctuation">,</span> isError<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'[</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">debugName</span></span><span class="token string">] </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">message</span></span><span class="token string">'</span></span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addHandler</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> server <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">serve</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> args<span class="token punctuation">.</span>config<span class="token punctuation">.</span>address<span class="token punctuation">,</span> args<span class="token punctuation">.</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> shared<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-return">return</span> <span class="token class-name">APIWorker</span><span class="token punctuation">.</span><span class="token function">_</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> router<span class="token punctuation">,</span> threadData<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">addCustomHandler</span><span class="token punctuation">(</span><span class="token class-name">CustomHandlerBase</span> customHandler<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>customHandler<span class="token punctuation">.</span>path<span class="token punctuation">,</span> customHandler<span class="token punctuation">.</span><span class="token function">createHandler</span><span class="token punctuation">(</span>_threadData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Future</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-await">await</span> _server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _args<span class="token punctuation">.</span><span class="token function">onClose</span><span class="token punctuation">(</span>_threadData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">CustomHandlerBase</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TThreadData</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">CustomThreadData</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">String</span> path<span class="token punctuation">;</span>

  <span class="token class-name">CustomHandlerBase</span><span class="token punctuation">(</span><span class="token punctuation">{</span>required <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>path<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">FutureOr</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token function">createHandler</span><span class="token punctuation">(</span><span class="token class-name">TThreadData</span> threadData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">CustomHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TThreadData</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">CustomThreadData</span><span class="token punctuation">&gt;</span></span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">CustomHandlerBase</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TThreadData</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">FutureOr</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">,</span> <span class="token class-name">TThreadData</span> threadData<span class="token punctuation">)</span> handle<span class="token punctuation">;</span>

  <span class="token class-name">CustomHandler</span><span class="token punctuation">(</span><span class="token punctuation">{</span>required <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span> required <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>handle<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">FutureOr</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token function">createHandler</span><span class="token punctuation">(</span><span class="token class-name">TThreadData</span> threadData<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">handle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> threadData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">CustomHandlerAuthRequired</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TClaims</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">IdentityTokenClaims</span><span class="token punctuation">,</span> <span class="token class-name">TThreadData</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">CustomThreadDataWithAuth</span><span class="token punctuation">&lt;</span><span class="token class-name">TClaims</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">CustomHandlerBase</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TThreadData</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">FutureOr</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">,</span> <span class="token class-name">TThreadData</span> threadData<span class="token punctuation">,</span> <span class="token class-name">IdentityToken</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TClaims</span><span class="token punctuation">&gt;</span></span> identityToken<span class="token punctuation">)</span> handle<span class="token punctuation">;</span>

  <span class="token class-name">CustomHandlerAuthRequired</span><span class="token punctuation">(</span><span class="token punctuation">{</span>required <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span> required <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>handle<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">FutureOr</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token function">createHandler</span><span class="token punctuation">(</span><span class="token class-name">TThreadData</span> threadData<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-final">final</span> encodedToken <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'token'</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>encodedToken <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">forbidden</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-final">final</span> identityToken <span class="token operator">=</span> threadData<span class="token punctuation">.</span>identityTokenAuthority<span class="token punctuation">.</span><span class="token function">verifyAndDecodeToken</span><span class="token punctuation">(</span>encodedToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>identityToken <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">forbidden</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword keyword-return">return</span> <span class="token function">handle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> threadData<span class="token punctuation">,</span> identityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">CustomThreadData</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">CustomThreadDataWithAuth</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TClaims</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">IdentityTokenClaims</span><span class="token punctuation">&gt;</span></span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">CustomThreadData</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">IdentityTokenAuthority</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TClaims</span><span class="token punctuation">&gt;</span></span> identityTokenAuthority<span class="token punctuation">;</span>

  <span class="token class-name">CustomThreadDataWithAuth</span><span class="token punctuation">(</span><span class="token punctuation">{</span>required <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>identityTokenAuthority<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">APIWorkerLaunchArgs</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">WorkerLaunchArgs</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">FutureOr</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CustomThreadData</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> createThreadData<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CustomHandlerBase</span><span class="token punctuation">&gt;</span></span> customHandlers<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">FutureOr</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token class-name">CustomThreadData</span> threadData<span class="token punctuation">)</span> onClose<span class="token punctuation">;</span>

  <span class="token class-name">APIWorkerLaunchArgs</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    required <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span>config<span class="token punctuation">,</span>
    required <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>createThreadData<span class="token punctuation">,</span>
    required <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>onClose<span class="token punctuation">,</span>
    <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>customHandlers <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword keyword-super">super</span><span class="token punctuation">(</span>start<span class="token punctuation">:</span> <span class="token class-name">APIWorker</span><span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>List of handlers used in music_server (note some functional programming aspects, the handle variable takes a Function object):</p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-final">final</span> musicServerCustomHandlers <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token class-name">CustomHandler</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/status'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> statusHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">CustomHandler</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/speedTest/&lt;size&gt;'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> speedTestHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token comment">// Auth</span>
  <span class="token class-name">CustomHandler</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/auth/createUser'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> authCreateUserHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">CustomHandler</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/auth/startSession'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> authStartSessionHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">CustomHandlerAuthRequired</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/auth/getName'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> authGetNameHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">CustomHandlerAuthRequired</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/auth/searchUser'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> authSearchUserHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token comment">// Song</span>
  <span class="token class-name">CustomHandlerAuthRequired</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/song/create'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> songCreateHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">CustomHandlerAuthRequired</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/song/uploadData'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> songUploadDataHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">CustomHandlerAuthRequired</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/song/uploadImage'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> songUploadImageHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">CustomHandlerAuthRequired</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/song/uploadDone'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> songUploadDoneHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">CustomHandlerAuthRequired</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/song/getData'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> songGetDataHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">CustomHandler</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/song/getImage/&lt;songId&gt;/&lt;size&gt;'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> songGetImageHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">CustomHandlerAuthRequired</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/song/search'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> songSearchHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">CustomHandlerAuthRequired</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/song/filter'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> songFilterHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">CustomHandlerAuthRequired</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/song/popular'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> songPopularHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token comment">// Sync</span>
  <span class="token class-name">CustomHandlerAuthRequired</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'/sync/startOrJoinSession'</span></span><span class="token punctuation">,</span> handle<span class="token punctuation">:</span> syncStartOrJoinSessionHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><h3 id="sessions">Sessions </h3>
<p>Each time the server starts, it generates a new random key to use with Hmac. If this server was deployed for real, this key should be rotated at runtime, and destroyed properly so it doesn't sit in memory for too long waiting to be garbage collected. With that said, I'm sure there is plenty of other security vulnerabilities dotted around.</p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-final">final</span> privateKey <span class="token operator">=</span> <span class="token function">generateSecureRandomKey</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>tokenKeyLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>The IdentityToken is analogous to a JWT (JSON Web Token). It is generated and signed by the server then stored on the client. On each API request, inside CustomHandlerAuthRequired, the tokens signature is verified to be authentic by comparing it to a freshly generated one based on the token's data. Tokens cannot be modified or forged as the signature would no longer match the token's data. In order to generate a valid signature, one would need to know the privateKey ^above.</p>
<p>Example of an IdentityToken and its signature:</p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
    <span class="token property">"uid"</span><span class="token operator">:</span> <span class="token string">"018cd0d2-a69b-7bbe-a056-650ece3dcfb7"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Will"</span><span class="token punctuation">,</span>
    <span class="token property">"time"</span><span class="token operator">:</span> <span class="token string">"2023-12-20T00:29:18.997310Z"</span><span class="token punctuation">,</span>
    <span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>
    <span class="token property">"agent"</span><span class="token operator">:</span> <span class="token string">"PostmanRuntime/7.36.0"</span><span class="token punctuation">,</span>
    <span class="token property">"key"</span><span class="token operator">:</span> &lt;random bytes&gt;<span class="token punctuation">,</span>
    <span class="token property">"claims"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"tier"</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><pre data-role="codeBlock" data-info="" class="language-text text"><code>0BClJqZtsVacCRHuf3+3MZIzoerHRJz75+5zdfxCRkY=
</code></pre><p>Passwords are hashed with Argon2 which is future proof against quantum computers.</p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-final">final</span> _passwordHashingAlgorithm <span class="token operator">=</span> <span class="token class-name">Argon2id</span><span class="token punctuation">(</span>
  parallelism<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  memory<span class="token punctuation">:</span> <span class="token number">19456</span><span class="token punctuation">,</span>
  iterations<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  hashLength<span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token metadata function">@embedded</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">HashedUserPassword</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>byte<span class="token punctuation">&gt;</span></span> nonce<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>byte<span class="token punctuation">&gt;</span></span> hash<span class="token punctuation">;</span>

  <span class="token class-name">HashedUserPassword</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>nonce <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-static">static</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HashedUserPassword</span><span class="token punctuation">&gt;</span></span> <span class="token function">createNew</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> passwordNonce <span class="token operator">=</span> <span class="token function">generateSecureRandomKey</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> passwordHash <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> _passwordHashingAlgorithm<span class="token punctuation">.</span><span class="token function">deriveKeyFromPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">:</span> password<span class="token punctuation">,</span> nonce<span class="token punctuation">:</span> passwordNonce<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> value<span class="token punctuation">.</span><span class="token function">extractBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token class-name">HashedUserPassword</span><span class="token punctuation">(</span>hash<span class="token punctuation">:</span> passwordHash<span class="token punctuation">,</span> nonce<span class="token punctuation">:</span> passwordNonce<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span>bool<span class="token punctuation">&gt;</span></span> <span class="token function">checkPasswordMatch</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> passwordHash <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> _passwordHashingAlgorithm<span class="token punctuation">.</span><span class="token function">deriveKeyFromPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">:</span> password<span class="token punctuation">,</span> nonce<span class="token punctuation">:</span> nonce<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> value<span class="token punctuation">.</span><span class="token function">extractBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token class-name">ListEquality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>passwordHash<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="transcoding">Transcoding </h4>
<p>A TranscodeWorker will acquire a new TranscodeOperation, which are inserted into the database when a song finishes uploading, and begin processing the audio</p>
<p>My audio transcoding process is very procedural, the function mainly consists of verification and error checking. I use ffmpeg's loudnorm filter to normalize the audio so that one song isn't louder than any others. Then I transcode to three different qualities with both libopus and libfdk_aac (aac wouldn't be necessary if apple used common standards, which would save more than half of the storage space since aac files are larger for the same quality - just to point out my frustrations).</p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">processAudio</span><span class="token punctuation">(</span><span class="token punctuation">{</span>required <span class="token class-name">MusicServerPaths</span> paths<span class="token punctuation">,</span> required <span class="token class-name">String</span> inputFile<span class="token punctuation">,</span> required <span class="token class-name">String</span> outputDir<span class="token punctuation">,</span> required <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AudioPreset</span><span class="token punctuation">&gt;</span></span> presets<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// get channel count</span>
    <span class="token keyword keyword-final">final</span> ffprobeResult <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>paths<span class="token punctuation">.</span>ffprobePath<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'-v'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'quiet'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-print_format'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'json'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-show_streams'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-select_streams'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'a:0'</span></span><span class="token punctuation">,</span> inputFile<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>ffprobeResult<span class="token punctuation">.</span>exitCode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffprobe exited with an error (</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">ffprobeResult<span class="token punctuation">.</span>exitCode</span><span class="token punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">ffprobeResult<span class="token punctuation">.</span>stderr</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> inputAudioFileInfoString <span class="token operator">=</span> ffprobeResult<span class="token punctuation">.</span>stdout <span class="token operator">as</span> <span class="token class-name">String</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>inputAudioFileInfoString <span class="token operator">==</span> <span class="token keyword keyword-null">null</span> <span class="token operator">||</span> inputAudioFileInfoString<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffprobe did not provide a result'</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> inputAudioFileInfo <span class="token operator">=</span> <span class="token function">jsonDecode</span><span class="token punctuation">(</span>inputAudioFileInfoString<span class="token punctuation">)</span> <span class="token operator">as</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword keyword-dynamic">dynamic</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>inputAudioFileInfo <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffprobe did not return json'</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> inputAudioStreams <span class="token operator">=</span> inputAudioFileInfo<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'streams'</span></span><span class="token punctuation">]</span> <span class="token operator">as</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword keyword-dynamic">dynamic</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>inputAudioStreams <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffprobe found no audio streams'</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> inputAudioFirstStream <span class="token operator">=</span> inputAudioStreams<span class="token punctuation">.</span>firstOrNull <span class="token operator">as</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword keyword-dynamic">dynamic</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>inputAudioFirstStream <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffprobe found no audio streams'</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> inputAudioChannelCount <span class="token operator">=</span> inputAudioFirstStream<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'channels'</span></span><span class="token punctuation">]</span> <span class="token operator">as</span> int<span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>inputAudioChannelCount <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffprobe output was malformated: first audio stream does not contain \'channels\''</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>inputAudioChannelCount <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'first audio stream has more than 2 channels'</span></span><span class="token punctuation">;</span>

    <span class="token comment">// normalize audio</span>
    <span class="token keyword keyword-final">final</span> loudnormResult <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>paths<span class="token punctuation">.</span>ffmpegPath<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'-i'</span></span><span class="token punctuation">,</span> inputFile<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-y'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-hide_banner'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-nostats'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-filter:a'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'loudnorm=print_format=json'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-f'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'null'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'NULL'</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>loudnormResult<span class="token punctuation">.</span>exitCode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffmpeg loudnorm exited with an error (</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">loudnormResult<span class="token punctuation">.</span>exitCode</span><span class="token punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">loudnormResult<span class="token punctuation">.</span>stderr</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> loudnormResultString <span class="token operator">=</span> loudnormResult<span class="token punctuation">.</span>stderr <span class="token operator">as</span> <span class="token class-name">String</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>loudnormResultString <span class="token operator">==</span> <span class="token keyword keyword-null">null</span> <span class="token operator">||</span> loudnormResultString<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffmpeg loudnorm did not provide a result'</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> loudnormStartIndex <span class="token operator">=</span> loudnormResultString<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'{'</span></span><span class="token punctuation">,</span> loudnormResultString<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'Parsed_loudnorm_0'</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> loudnormEndIndex <span class="token operator">=</span> loudnormResultString<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'}'</span></span><span class="token punctuation">,</span> loudnormStartIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> loudnormParsedResultString <span class="token operator">=</span> loudnormResultString<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>loudnormStartIndex<span class="token punctuation">,</span> loudnormEndIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>loudnormParsedResultString<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffmpeg loudnorm did not provide a result or the result was malformed'</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> loudnormParsedResult <span class="token operator">=</span> <span class="token function">jsonDecode</span><span class="token punctuation">(</span>loudnormParsedResultString<span class="token punctuation">)</span> <span class="token operator">as</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword keyword-dynamic">dynamic</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>loudnormParsedResult <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffmpeg loudnorm did not provide a result or the result was malformed'</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> measured_i <span class="token operator">=</span> loudnormParsedResult<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'input_i'</span></span><span class="token punctuation">]</span> <span class="token operator">as</span> <span class="token class-name">String</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>measured_i <span class="token operator">==</span> <span class="token keyword keyword-null">null</span> <span class="token operator">||</span> measured_i<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffmpeg loudnorm result was malformed, input_i was null or empty'</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> measured_tp <span class="token operator">=</span> loudnormParsedResult<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'input_tp'</span></span><span class="token punctuation">]</span> <span class="token operator">as</span> <span class="token class-name">String</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>measured_tp <span class="token operator">==</span> <span class="token keyword keyword-null">null</span> <span class="token operator">||</span> measured_tp<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffmpeg loudnorm result was malformed, input_tp was null or empty'</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> measured_lra <span class="token operator">=</span> loudnormParsedResult<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'input_lra'</span></span><span class="token punctuation">]</span> <span class="token operator">as</span> <span class="token class-name">String</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>measured_lra <span class="token operator">==</span> <span class="token keyword keyword-null">null</span> <span class="token operator">||</span> measured_lra<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffmpeg loudnorm result was malformed, input_lra was null or empty'</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> measured_thresh <span class="token operator">=</span> loudnormParsedResult<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'input_thresh'</span></span><span class="token punctuation">]</span> <span class="token operator">as</span> <span class="token class-name">String</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>measured_thresh <span class="token operator">==</span> <span class="token keyword keyword-null">null</span> <span class="token operator">||</span> measured_thresh<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffmpeg loudnorm result was malformed, input_thresh was null or empty'</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-const">const</span> target_i <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'-14.0'</span></span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> target_tp <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'-2.0'</span></span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> target_lra <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'7.0'</span></span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> target_offset <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'0.0'</span></span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> intermediateInputFile <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">p<span class="token punctuation">.</span><span class="token function">withoutExtension</span><span class="token punctuation">(</span>inputFile<span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">_normalized</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">p<span class="token punctuation">.</span><span class="token keyword keyword-extension">extension</span><span class="token punctuation">(</span>inputFile<span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">;</span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-final">final</span> loudnormStep2Result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>paths<span class="token punctuation">.</span>ffmpegPath<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'-i'</span></span><span class="token punctuation">,</span> inputFile<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-y'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-map_metadata'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-1'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-map'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'0:a'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-filter:a'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'loudnorm=linear=true:i=</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">target_i</span></span><span class="token string">:lra=</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">target_lra</span></span><span class="token string">:tp=</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">target_tp</span></span><span class="token string">:offset=</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">target_offset</span></span><span class="token string">:measured_I=</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">measured_i</span></span><span class="token string">:measured_tp=</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">measured_tp</span></span><span class="token string">:measured_LRA=</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">measured_lra</span></span><span class="token string">:measured_thresh=</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">measured_thresh</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> intermediateInputFile<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>loudnormStep2Result<span class="token punctuation">.</span>exitCode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffmpeg loudnorm step 2 exited with an error (</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">loudnormStep2Result<span class="token punctuation">.</span>exitCode</span><span class="token punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">loudnormStep2Result<span class="token punctuation">.</span>stderr</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">;</span>

      <span class="token comment">// transcode with each preset</span>
      <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">processPreset</span><span class="token punctuation">(</span><span class="token class-name">AudioPreset</span> preset<span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-final">final</span> outputFile <span class="token operator">=</span> <span class="token function">getAudioOutputFilePath</span><span class="token punctuation">(</span>outputDir<span class="token punctuation">,</span> preset<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword keyword-final">final</span> encodeParameters <span class="token operator">=</span> <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>preset<span class="token punctuation">.</span>format<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">CompressedAudioFormat</span><span class="token punctuation">.</span>opus <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'-i'</span></span><span class="token punctuation">,</span> intermediateInputFile<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-y'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-v'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'warning'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-progress'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-codec:a'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'libopus'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-mapping_family'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'0'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-b:a'</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>preset<span class="token punctuation">.</span>quality<span class="token punctuation">.</span>opuskbpsPerChannel <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> inputAudioChannelCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> outputFile<span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token class-name">CompressedAudioFormat</span><span class="token punctuation">.</span>aac <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'-i'</span></span><span class="token punctuation">,</span> intermediateInputFile<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-y'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-v'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'warning'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-progress'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-codec:a'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'libfdk_aac'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-vbr'</span></span><span class="token punctuation">,</span> preset<span class="token punctuation">.</span>quality<span class="token punctuation">.</span>aacVBRMode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> outputFile<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-final">final</span> transcodeResult <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>paths<span class="token punctuation">.</span>ffmpegPath<span class="token punctuation">,</span> encodeParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>transcodeResult<span class="token punctuation">.</span>exitCode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ffmpeg transcode on preset </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">preset</span></span><span class="token string"> exited with an error (</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">transcodeResult<span class="token punctuation">.</span>exitCode</span><span class="token punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">transcodeResult<span class="token punctuation">.</span>stderr</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">;</span>

        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">&gt;</span></span> <span class="token function">revert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-final">final</span> preset <span class="token keyword keyword-in">in</span> presets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword keyword-final">final</span> outputFileObject <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token function">getAudioOutputFilePath</span><span class="token punctuation">(</span>outputDir<span class="token punctuation">,</span> preset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-await">await</span> outputFileObject<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-await">await</span> outputFileObject<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword keyword-await">await</span> <span class="token class-name">Directory</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>outputDir<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'audio'</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>recursive<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>transcodePresetsSimultaneously<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword keyword-final">final</span> processResultsFutures <span class="token operator">=</span> presets<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>processPreset<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword keyword-final">final</span> processResults <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>processResultsFutures<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-final">final</span> processResult <span class="token keyword keyword-in">in</span> processResults<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>processResult <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword keyword-await">await</span> <span class="token function">revert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword keyword-return">return</span> processResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
          <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-final">final</span> preset <span class="token keyword keyword-in">in</span> presets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-final">final</span> processResult <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">processPreset</span><span class="token punctuation">(</span>preset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>processResult <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword keyword-await">await</span> <span class="token function">revert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword keyword-return">return</span> processResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-await">await</span> <span class="token function">revert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-finally">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-final">final</span> intermediateInputFileObject <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">(</span>intermediateInputFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-await">await</span> intermediateInputFileObject<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-await">await</span> intermediateInputFileObject<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Image processing is similar and uses ImageMagick.</p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-final">final</span> encodeParameters <span class="token operator">=</span> <span class="token punctuation">[</span>inputFile<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-resize'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">size<span class="token punctuation">.</span>resolution</span><span class="token punctuation">}</span></span><span class="token string">^'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-gravity'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'center'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'-extent'</span></span><span class="token punctuation">,</span> size<span class="token punctuation">.</span>resolution<span class="token punctuation">,</span> outputFile<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword keyword-final">final</span> transcodeResult <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>paths<span class="token punctuation">.</span>magickPath<span class="token punctuation">,</span> encodeParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id="search">Search </h4>
<p>This snippet from songSearchHandler preforms a query on the stored and indexed phonetic codes of each song's name. Isar generates functions with names based on the variables in the data model, ie in "sortByPopularityDesc", popularity is a double stored in each song document. Searching on indexes is much faster than filtering each document, and using phonetic codes allows that search to still be fuzzy (such as allowing a spelling error in a song title).</p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-final">final</span> queryPhonetics <span class="token operator">=</span> <span class="token function">getPhoneticCodesOfQuery</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-final">final</span> searchResults <span class="token operator">=</span> threadData<span class="token punctuation">.</span>isar<span class="token punctuation">.</span>songs<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyOf</span><span class="token punctuation">(</span>queryPhonetics<span class="token punctuation">,</span> <span class="token punctuation">(</span>q<span class="token punctuation">,</span> element<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> q<span class="token punctuation">.</span><span class="token function">namePhoneticsElementEqualTo</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sortByPopularityDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAllSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-return">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token function">jsonEncode</span><span class="token punctuation">(</span>searchResults<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>song<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> song<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id="sync-session">Sync Session </h4>
<p>Here's a tongue twister: SyncSessionWorkers manage web socket servers that mediate sync sessions.</p>
<p>Sync sessions allow multiple clients signed in as the same user to play music at the same time, over the LAN this can be quite precise.</p>
<p>The server serves mainly as a relay to allow clients to send messages to each other. But some important logic is preformed in this case statement inside _onRequest. The 'effective' time is in the future, it is the exact time the clients should begin playback.</p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-case">case</span> <span class="token string-literal"><span class="token string">'callTimeSensitive'</span></span><span class="token punctuation">:</span>
  <span class="token keyword keyword-final">final</span> call <span class="token operator">=</span> json<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'call'</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> effective <span class="token operator">=</span> <span class="token class-name">DateTime</span><span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">(</span>milliseconds<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>microsecondsSinceEpoch<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> response <span class="token operator">=</span> <span class="token function">jsonEncode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string-literal"><span class="token string">'method'</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'callTimeSensitive'</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">'call'</span></span><span class="token punctuation">:</span> call<span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">'effective'</span></span><span class="token punctuation">:</span> effective<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-final">final</span> client <span class="token keyword keyword-in">in</span> clients<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
</code></pre><p>Client side, the difference between the server and client device's clocks is calculated.</p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-void">void</span> <span class="token function">_timeResponse</span><span class="token punctuation">(</span><span class="token keyword keyword-dynamic">dynamic</span> json<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> clientReceiveTimestamp <span class="token operator">=</span> <span class="token class-name">DateTime</span><span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>_clientSendTimestamp <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> serverSentTimestamp <span class="token operator">=</span> <span class="token class-name">DateTime</span><span class="token punctuation">.</span><span class="token function">fromMicrosecondsSinceEpoch</span><span class="token punctuation">(</span>json<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'sent'</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> roundTripDuration <span class="token operator">=</span> clientReceiveTimestamp<span class="token punctuation">.</span><span class="token function">difference</span><span class="token punctuation">(</span>_clientSendTimestamp<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> fromServerDuration <span class="token operator">=</span> clientReceiveTimestamp<span class="token punctuation">.</span><span class="token function">difference</span><span class="token punctuation">(</span>serverSentTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    latency <span class="token operator">=</span> roundTripDuration<span class="token punctuation">.</span>inMicroseconds <span class="token operator">~/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    difference <span class="token operator">=</span> fromServerDuration<span class="token punctuation">.</span>inMicroseconds <span class="token operator">-</span> latency<span class="token punctuation">;</span>

    syncSessionChangedController<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>syncSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><p>The difference value is then used determine how long the client should wait before beginning playback.</p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-void">void</span> <span class="token function">_playResponse</span><span class="token punctuation">(</span><span class="token keyword keyword-dynamic">dynamic</span> json<span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
    _clientSendTimestamp <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> effective <span class="token operator">=</span> <span class="token class-name">DateTime</span><span class="token punctuation">.</span><span class="token function">fromMicrosecondsSinceEpoch</span><span class="token punctuation">(</span>json<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'effective'</span></span><span class="token punctuation">]</span> <span class="token operator">+</span> difference<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> microsecondsUntilCall <span class="token operator">=</span> effective<span class="token punctuation">.</span><span class="token function">difference</span><span class="token punctuation">(</span><span class="token class-name">DateTime</span><span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>inMicroseconds<span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">(</span>microseconds<span class="token punctuation">:</span> microsecondsUntilCall<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-await">await</span> appPlayer<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><h3 id="mobile-and-web-clients">Mobile and Web Clients </h3>
<h4 id="visuals">Visuals </h4>
<p>This is the main logic of a gradient shader I use as a background nearly everywhere. Each of the arrays, uPointPositions, uPointSizes, and uPointColors, contain 4 elements. Each fragment simply measures its distance to each of the points and adds that point's color multiplied by a distance based falloff.</p>
<pre data-role="codeBlock" data-info="glsl" class="language-glsl glsl"><code><span class="token keyword keyword-float">float</span> <span class="token function">falloff</span><span class="token punctuation">(</span><span class="token keyword keyword-float">float</span> dist<span class="token punctuation">,</span> <span class="token keyword keyword-float">float</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token function">clamp</span><span class="token punctuation">(</span>dist <span class="token operator">/</span> size<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-vec2">vec2</span> fragPosition <span class="token operator">=</span> <span class="token function">FlutterFragCoord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">;</span>

    <span class="token keyword keyword-vec4">vec4</span> totalColor <span class="token operator">=</span> <span class="token keyword keyword-vec4">vec4</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numPoints<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-vec2">vec2</span> pointPosition <span class="token operator">=</span> uPointPositions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-float">float</span> pointSize <span class="token operator">=</span> uPointSizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-vec3">vec3</span> pointColor <span class="token operator">=</span> uPointColors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword keyword-float">float</span> dist <span class="token operator">=</span> <span class="token function">distance</span><span class="token punctuation">(</span>pointPosition<span class="token punctuation">,</span> fragPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-float">float</span> intensity <span class="token operator">=</span> <span class="token function">falloff</span><span class="token punctuation">(</span>dist<span class="token punctuation">,</span> pointSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        totalColor <span class="token operator">+=</span> <span class="token keyword keyword-vec4">vec4</span><span class="token punctuation">(</span>pointColor<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> intensity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    fragColor <span class="token operator">=</span> totalColor <span class="token operator">*</span> outputIntensity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>On the Dart side, I generate random positions with a simple poisson disk sample</p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">/// Simple Poisson Disk Sampling. Generates random points until count valid points are found. Fails after 100 unsuccessful samples.</span>
<span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token punctuation">(</span>double x<span class="token punctuation">,</span> double y<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">poissonDiskSample</span><span class="token punctuation">(</span><span class="token punctuation">{</span>required int count<span class="token punctuation">,</span> required double radius<span class="token punctuation">,</span> required double sizeX<span class="token punctuation">,</span> required double sizeY<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> points <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>_random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> sizeX<span class="token punctuation">,</span> _random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> sizeY<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-var">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-var">var</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> sample <span class="token operator">=</span> <span class="token punctuation">(</span>_random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> sizeX<span class="token punctuation">,</span> _random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> sizeY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-var">var</span> valid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-final">final</span> point <span class="token keyword keyword-in">in</span> points<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-final">final</span> difference <span class="token operator">=</span> <span class="token punctuation">(</span>sample<span class="token punctuation">.</span>$<span class="token number">1</span> <span class="token operator">-</span> point<span class="token punctuation">.</span>$<span class="token number">1</span><span class="token punctuation">,</span> sample<span class="token punctuation">.</span>$<span class="token number">2</span> <span class="token operator">-</span> point<span class="token punctuation">.</span>$<span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> distance <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>$<span class="token number">1</span> <span class="token operator">*</span> difference<span class="token punctuation">.</span>$<span class="token number">1</span> <span class="token operator">+</span> difference<span class="token punctuation">.</span>$<span class="token number">2</span> <span class="token operator">*</span> difference<span class="token punctuation">.</span>$<span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>distance <span class="token operator">&lt;</span> radius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      points<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sample<span class="token punctuation">)</span><span class="token punctuation">;</span>
      i<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> count<span class="token punctuation">)</span> <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// If no more points can be generated, force random sample</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>points<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> count<span class="token punctuation">)</span> points<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>count <span class="token operator">-</span> points<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>_random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> sizeX<span class="token punctuation">,</span> _random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> sizeY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-return">return</span> points<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Then I take two samples and interpolate between them</p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-final">final</span> pointPositions <span class="token operator">=</span> <span class="token function">lerpPositions</span><span class="token punctuation">(</span>pointPositionsA<span class="token operator">!</span><span class="token punctuation">,</span> pointPositionsB<span class="token operator">!</span><span class="token punctuation">,</span> animationController<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>An image of the gradient with some red and blue colors is labeled 'Music Service Gradient Background'. More demonstrations are in the video.</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>